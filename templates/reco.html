<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ì˜ ë§›ì§‘ ì¶”ì²œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
        "Noto Sans KR", system-ui, sans-serif;
      background: #f5f5f7;
      color: #111827;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 6px;
    }

    header p {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }

    .status-box {
      margin: 10px 0 16px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #e5f0ff;
      color: #1f3b7b;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-box span.emoji {
      font-size: 18px;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      gap: 6px;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-primary.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-outline {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #374151;
      font-size: 12px;
      cursor: pointer;
      gap: 4px;
    }

    .btn-outline:disabled {
      opacity: 0.4;
      cursor: default;
    }

    /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
    .cards-container-wrapper {
      position: relative;
      margin-top: 10px;
    }

    .cards-container {
      display: flex;
      flex-direction: row;
      gap: 16px;
      overflow-x: auto;
      padding: 10px 4px 8px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .cards-container::-webkit-scrollbar {
      display: none;
    }

    .card {
      position: relative;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      padding: 0;
      min-width: 280px;
      max-width: 320px;
      scroll-snap-align: center;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .cards-container {
        justify-content: center;
      }

      .card {
        min-width: 320px;
        max-width: 360px;
      }
    }

    /* ì¸ë„¤ì¼ + ìŠ¬ë¼ì´ë” */
    .thumb {
      width: 100%;
      height: 190px;
      position: relative;
      overflow: hidden;
      background: #f2f3f6;
      border-radius: 20px 20px 0 0;
    }

    .thumb-inner {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .thumb-slider {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease;
    }

    .thumb-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
    }

    .thumb-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }

    .thumb-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    .thumb-nav.prev {
      left: 8px;
    }

    .thumb-nav.next {
      right: 8px;
    }

    .thumb-dots {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
    }

    .thumb-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.4);
      cursor: pointer;
    }

    .thumb-dot.active {
      background: rgba(255, 255, 255, 0.95);
    }

    .thumb-badge {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
    }

    /* ì¹´ë“œ ë³¸ë¬¸ */
    .card-body {
      padding: 14px 16px 14px;
    }

    .card-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }

    .rating {
      font-size: 12px;
      color: #f97316;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .badge.primary {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .menu-text {
      font-size: 13px;
      margin-bottom: 4px;
      color: #111827;
    }

    .summary-text {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .address-text {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .open-info {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .keyword-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 10px;
    }

    .keyword {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .card-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .card-actions-left {
      display: flex;
      gap: 6px;
    }

    .card-actions-right {
      display: flex;
      gap: 6px;
    }

    .btn-map {
      font-size: 12px;
      padding: 6px 11px;
      border-radius: 999px;
      border: none;
      background: #16a34a;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .btn-map span.icon {
      font-size: 14px;
    }

    .empty-msg {
      font-size: 13px;
      color: #6b7280;
      margin-top: 18px;
    }

    .small-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <h1>ì˜¤ëŠ˜ì˜ ë§›ì§‘ ì¶”ì²œ</h1>
    <p id="userInfoText"></p>
  </header>

  <div class="status-box" id="statusBox">
    <span class="emoji">ğŸ“</span>
    <span id="statusText">í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
  </div>

  <button class="btn-primary small" id="retryLocationBtn" style="display:none;">
    ìœ„ì¹˜ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
  </button>

  <div class="cards-container-wrapper">
    <div id="cards" class="cards-container"></div>
    <div id="emptyMessage" class="empty-msg" style="display:none;">
      ì£¼ë³€ì—ì„œ ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ë§›ì§‘ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
    </div>
    <div id="hintText" class="small-hint" style="display:none;">
      ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€, ë˜ëŠ” ë‹¤ë¥¸ ì‹œê°„ëŒ€(ì•„ì¹¨/ì ì‹¬/ì €ë…/ì•¼ì‹)ë¡œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
    </div>
  </div>
</div>

<script>
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name) || "";
  }

  const phone = getQueryParam("phone");
  const timeOfDay = getQueryParam("time");

  const statusBox = document.getElementById("statusBox");
  const statusText = document.getElementById("statusText");
  const retryLocationBtn = document.getElementById("retryLocationBtn");
  const cardsEl = document.getElementById("cards");
  const emptyMessageEl = document.getElementById("emptyMessage");
  const hintTextEl = document.getElementById("hintText");

  const userInfoText = document.getElementById("userInfoText");
  const prettyTime = timeOfDay ? timeOfDay : "ë¯¸ì§€ì •";
  if (phone) {
    userInfoText.textContent = `ì „í™”ë²ˆí˜¸: ${phone} Â· ì¶”ì²œ ì‹œê°„ëŒ€: ${prettyTime}`;
  } else {
    userInfoText.textContent = `ì¶”ì²œ ì‹œê°„ëŒ€: ${prettyTime}`;
  }

  function setStatus(text, isError) {
    statusText.textContent = text;
    if (isError) {
      statusBox.style.background = "#fee2e2";
      statusBox.style.color = "#b91c1c";
    } else {
      statusBox.style.background = "#e5f0ff";
      statusBox.style.color = "#1f3b7b";
    }
  }

  function startLocation() {
    retryLocationBtn.style.display = "none";
    setStatus("í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", false);

    if (!navigator.geolocation) {
      setStatus("ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", true);
      retryLocationBtn.style.display = "inline-flex";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        setStatus("ë‚´ ì£¼ë³€ ë§›ì§‘ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...", false);
        fetchRecommendations(lat, lon);
      },
      (err) => {
        console.error(err);
        setStatus("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", true);
        retryLocationBtn.style.display = "inline-flex";
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
      }
    );
  }

  retryLocationBtn.addEventListener("click", startLocation);

  async function fetchRecommendations(lat, lon) {
    try {
      const resp = await fetch("/api/reco", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: phone,
          time: timeOfDay,
          lat: lat,
          lon: lon,
        }),
      });

      if (!resp.ok) {
        setStatus("ì¶”ì²œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", true);
        emptyMessageEl.style.display = "block";
        hintTextEl.style.display = "block";
        return;
      }

      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        setStatus("ì£¼ë³€ì— ì¶”ì²œí•  ë§›ì§‘ì´ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”.", true);
        cardsEl.innerHTML = "";
        emptyMessageEl.style.display = "block";
        hintTextEl.style.display = "block";
        return;
      }

      setStatus("ì˜¤ëŠ˜ ì´ëŸ° ê³³ì€ ì–´ë– ì„¸ìš”?", false);
      emptyMessageEl.style.display = "none";
      hintTextEl.style.display = "none";
      showCards(data);
    } catch (e) {
      console.error(e);
      setStatus("ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
      emptyMessageEl.style.display = "block";
      hintTextEl.style.display = "block";
    }
  }

  function buildDistanceText(distanceKm) {
    if (distanceKm == null) return "";
    const d = Number(distanceKm);

    if (isNaN(d)) return "";
    if (d <= 0.3) return `ë„ë³´ 5ë¶„ ì´ë‚´ (~${d.toFixed(1)}km)`;
    if (d <= 1.0) return `ë„ë³´ 10~15ë¶„ ì´ë‚´ (~${d.toFixed(1)}km)`;
    return `ì°¨ë¡œ ê°€ê¸° ì¢‹ì€ ê±°ë¦¬ (~${d.toFixed(1)}km)`;
  }

  function showCards(data) {
    cardsEl.innerHTML = "";

    data.forEach((item) => {
      const card = document.createElement("div");
      card.className = "card";

      const distanceText = buildDistanceText(item.distance_km);

      const mainImage =
        (item.images && item.images.length && item.images[0]) ||
        item.image_url ||
        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumnail.png";

      const images =
        item.images && item.images.length > 0
          ? item.images
          : [mainImage];

      const imagesHtml = images
        .map(
          (src, idx) => `
            <div class="thumb-slide" data-index="${idx}">
              <img src="${src}" alt="${item.name || ""}" loading="lazy" />
            </div>
          `
        )
        .join("");

      const keywords = Array.isArray(item.keywords) ? item.keywords : [];
      const keywordHtml = keywords
        .map((kw) => `<span class="keyword">${kw}</span>`)
        .join("");

      const ratingHtml =
        item.rating != null
          ? `<div class="rating">â­ ${item.rating.toFixed(1)}</div>`
          : "";

      const menuText = item.menu || "";
      const summaryText = item.summary || "";

      const addressText = item.address || "";
      const openInfo = item.open_info || "";

      const categoryBadge = item.category
        ? `<span class="badge primary">${item.category}</span>`
        : "";

      card.innerHTML = `
        <div class="thumb">
          <div class="thumb-inner" data-total="${images.length}">
            <div class="thumb-slider">
              ${imagesHtml}
            </div>
            ${
              images.length > 1
                ? `
                  <button class="thumb-nav prev" type="button">&#8249;</button>
                  <button class="thumb-nav next" type="button">&#8250;</button>
                  <div class="thumb-dots">
                    ${images
                      .map(
                        (_, i) =>
                          `<button class="thumb-dot ${
                            i === 0 ? "active" : ""
                          }" data-index="${i}" type="button"></button>`
                      )
                      .join("")}
                  </div>
                `
                : ""
            }
          </div>
          ${
            distanceText
              ? `<div class="thumb-badge">${distanceText}</div>`
              : ""
          }
        </div>

        <div class="card-body">
          <div class="card-title-row">
            <div class="card-title">${item.name || "ì´ë¦„ ì—†ëŠ” ê°€ê²Œ"}</div>
            ${ratingHtml}
          </div>

          <div class="badge-row">
            ${categoryBadge}
          </div>

          ${
            menuText
              ? `<div class="menu-text">${menuText}</div>`
              : ""
          }

          ${
            summaryText
              ? `<div class="summary-text">${summaryText}</div>`
              : ""
          }

          ${
            addressText
              ? `<div class="address-text">ğŸ“ ${addressText}</div>`
              : ""
          }

          ${
            openInfo
              ? `<div class="open-info">â° ${openInfo}</div>`
              : ""
          }

          ${
            keywordHtml
              ? `<div class="keyword-row">${keywordHtml}</div>`
              : ""
          }

          <div class="card-actions">
            <div class="card-actions-left">
              <button class="btn-outline btn-like" type="button">
                ğŸ‘ ì¢‹ì•„ìš”
              </button>
              <button class="btn-outline btn-dislike" type="button">
                ğŸ‘ ë³„ë¡œì˜ˆìš”
              </button>
            </div>
            <div class="card-actions-right">
              <button class="btn-map" type="button">
                <span class="icon">ğŸ—º</span>
                ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì´ë™
              </button>
            </div>
          </div>
        </div>
      `;

      cardsEl.appendChild(card);
      initThumbSlider(card);

      const likeBtn = card.querySelector(".btn-like");
      const dislikeBtn = card.querySelector(".btn-dislike");
      const mapBtn = card.querySelector(".btn-map");

      likeBtn.addEventListener("click", () =>
        sendQuickFeedback(item, true, likeBtn, dislikeBtn)
      );
      dislikeBtn.addEventListener("click", () =>
        sendQuickFeedback(item, false, likeBtn, dislikeBtn)
      );
      mapBtn.addEventListener("click", () =>
        goKakaoMap(item)
      );
    });
  }

  function initThumbSlider(cardEl) {
    const slider = cardEl.querySelector(".thumb-slider");
    const slides = cardEl.querySelectorAll(".thumb-slide");
    if (!slider || !slides.length) return;

    const prevBtn = cardEl.querySelector(".thumb-nav.prev");
    const nextBtn = cardEl.querySelector(".thumb-nav.next");
    const dots = cardEl.querySelectorAll(".thumb-dot");
    const total = slides.length;

    let index = 0;

    function update() {
      slider.style.transform = `translateX(${-index * 100}%)`;
      dots.forEach((dot, i) => {
        if (i === index) dot.classList.add("active");
        else dot.classList.remove("active");
      });
    }

    if (prevBtn && nextBtn) {
      prevBtn.addEventListener("click", () => {
        index = (index - 1 + total) % total;
        update();
      });
      nextBtn.addEventListener("click", () => {
        index = (index + 1) % total;
        update();
      });
    }

    dots.forEach((dot, i) => {
      dot.addEventListener("click", () => {
        index = i;
        update();
      });
    });

    let startX = 0;
    let isDragging = false;

    slider.addEventListener("touchstart", (e) => {
      if (!e.touches || !e.touches.length) return;
      startX = e.touches[0].clientX;
      isDragging = true;
    });

    slider.addEventListener("touchend", (e) => {
      if (!isDragging) return;
      isDragging = false;
      if (!e.changedTouches || !e.changedTouches.length) return;

      const diff = e.changedTouches[0].clientX - startX;
      const threshold = 40;

      if (diff > threshold) {
        index = (index - 1 + total) % total;
        update();
      } else if (diff < -threshold) {
        index = (index + 1) % total;
        update();
      }
    });

    update();
  }

  function sendQuickFeedback(item, isLike, likeBtn, dislikeBtn) {
    if (!phone) {
      alert("ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ì—†ì–´ í”¼ë“œë°±ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    likeBtn.disabled = true;
    dislikeBtn.disabled = true;

    fetch("/api/quick-feedback", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone: phone,
        restaurant_name: item.name,
        category: item.category,
        is_good: isLike,
      }),
    })
      .then((r) => r.json())
      .then((res) => {
        if (res && res.result === "ok") {
          if (isLike) {
            likeBtn.textContent = "ğŸ‘ ë°˜ì˜ë¨";
          } else {
            dislikeBtn.textContent = "ğŸ‘ ë°˜ì˜ë¨";
          }
        } else {
          alert("í”¼ë“œë°± ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          likeBtn.disabled = false;
          dislikeBtn.disabled = false;
        }
      })
      .catch((e) => {
        console.error(e);
        alert("í”¼ë“œë°± ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        likeBtn.disabled = false;
        dislikeBtn.disabled = false;
      });
  }

  function goKakaoMap(item) {
    if (item.place_id) {
      const url =
        "/go?place_id=" +
        encodeURIComponent(item.place_id) +
        "&name=" +
        encodeURIComponent(item.name || "");
      window.location.href = url;
    } else if (item.lat && item.lon) {
      const url =
        "/go?lat=" +
        encodeURIComponent(item.lat) +
        "&lon=" +
        encodeURIComponent(item.lon) +
        "&name=" +
        encodeURIComponent(item.name || "");
      window.location.href = url;
    } else {
      window.location.href = "https://map.kakao.com/";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    startLocation();
  });
</script>
</body>
</html>
