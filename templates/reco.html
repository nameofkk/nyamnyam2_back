<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜¤ëŠ˜ì˜ ì¶”ì²œ Â· ëƒ ëƒ ì´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #fafafa;
      color: #222;
    }

    /* ìƒë‹¨ ì •ë³´ ì˜ì—­ */
    .header {
      text-align: center;
      padding: 24px 16px;
      background: #fff;
      border-bottom: 1px solid #eee;
    }
    .header h2 {
      font-size: 22px;
      margin-bottom: 6px;
    }
    .header p {
      font-size: 14px;
      color: #555;
    }

    /* ë¡œë”© ì˜ì—­ */
    #loading {
      text-align: center;
      margin-top: 40px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: auto;
      border: 4px solid #ddd;
      border-top: 4px solid #ff7b54;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    #loading p {
      margin-top: 14px;
      color: #777;
      font-size: 14px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ (ê°€ë¡œ ìŠ¤í¬ë¡¤) */
    #cards {
      display: none;              /* ì²˜ìŒì—” ìˆ¨ê¹€ */
      margin-top: 20px;
      padding-left: 20px;
      padding-right: 20px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      gap: 16px;
      display: flex;
    }
    #cards::-webkit-scrollbar { display: none; }

    /* ê°œë³„ ì¹´ë“œ */
    .card {
      flex: 0 0 80%;
      max-width: 280px;
      background: #fff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      scroll-snap-align: center;
    }
    .card h3 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    .tag {
      display: inline-block;
      background: #ffecd9;
      color: #ff7a3d;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin-bottom: 10px;
      margin-right: 4px;
    }

    .menu {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .desc {
      color: #555;
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 12px;
    }

    /* ì§€ë„ ë²„íŠ¼ */
    .btn-map {
      display: block;
      width: 100%;
      text-align: center;
      background: #4785ff;
      color: white;
      padding: 10px 0;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }

    /* í•˜ë‹¨ ì—¬ë°± (ì—¬ìœ  ê³µê°„) */
    .bottom-space {
      height: 60px;
    }
  </style>
</head>

<body>

  <div class="header">
    <h2>ì˜¤ëŠ˜ì˜ ë§›ì§‘ ì¶”ì²œ</h2>
    <p>{{ phone }}ë‹˜ì„ ìœ„í•œ {{ time }} ì¶”ì²œ 3ê³³</p>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    <p>AIê°€ ì£¼ë³€ ë§›ì§‘ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
  </div>

  <div id="cards"></div>
  <div class="bottom-space"></div>

  <script>
    const phone = "{{ phone }}";
    const timeOfDay = "{{ time }}";

    const loadingEl = document.getElementById("loading");
    const loadingTextEl = loadingEl.querySelector("p");
    const cardsEl = document.getElementById("cards");

    // í…ìŠ¤íŠ¸ë§Œ ë°”ê¾¸ëŠ” í—¬í¼ í•¨ìˆ˜
    function setLoadingText(text) {
      loadingEl.style.display = "block";
      if (loadingTextEl) loadingTextEl.innerText = text;
    }

    document.addEventListener("DOMContentLoaded", start);

    // -----------------------------
    // 1. ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° â†’ /api/reco í˜¸ì¶œ
    // -----------------------------
    function start() {
      console.log("[RECO] start() called");

      // geolocation ìì²´ê°€ ì—†ëŠ” ë¸Œë¼ìš°ì €
      if (!navigator.geolocation) {
        setLoadingText("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
        fetchReco(33.462046, 126.329235); // ì œì£¼ ì• ì›” ê¸°ë³¸ ì¢Œí‘œ
        return;
      }

      let called = false;

      function go(lat, lon) {
        if (called) return;
        called = true;
        console.log("[RECO] ìœ„ì¹˜ ì‚¬ìš©:", lat, lon);
        fetchReco(lat, lon);
      }

      try {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            // ì •ìƒ ìœ„ì¹˜ ìˆ˜ì‹ 
            go(pos.coords.latitude, pos.coords.longitude);
          },
          (err) => {
            // ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ / ì‹¤íŒ¨
            console.error("[RECO] ìœ„ì¹˜ ì˜¤ë¥˜(ì½œë°±):", err);
            setLoadingText("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
            go(33.462046, 126.329235);
          },
          {
            enableHighAccuracy: true,
            timeout: 7000,
            maximumAge: 600000,
          }
        );
      } catch (e) {
        // getCurrentPosition ìì²´ê°€ ì˜ˆì™¸ ë‚˜ëŠ” ê²½ìš°
        console.error("[RECO] ìœ„ì¹˜ API ì˜ˆì™¸(try/catch):", e);
        setLoadingText("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
        go(33.462046, 126.329235);
      }

      // geolocationì´ ë„ˆë¬´ ì˜¤ë˜ ë©ˆì¶° ìˆëŠ” ê²½ìš° ìµœì¢… íƒ€ì„ì•„ì›ƒ
      setTimeout(() => {
        if (!called) {
          console.warn("[RECO] ìœ„ì¹˜ ì‘ë‹µ ì§€ì—° â†’ ê¸°ë³¸ ì¢Œí‘œ ì‚¬ìš©");
          setLoadingText("ìœ„ì¹˜ ì‘ë‹µì´ ëŠë¦½ë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
          go(33.462046, 126.329235);
        }
      }, 8000);
    }

    // -----------------------------
    // 2. /api/reco í˜¸ì¶œ
    // -----------------------------
    function fetchReco(lat, lon) {
      setLoadingText("ì£¼ë³€ ë§›ì§‘ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
      cardsEl.style.display = "none";
      cardsEl.innerHTML = "";

      fetch("/api/reco", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: phone,
          time: timeOfDay,
          lat: lat,
          lon: lon,
        }),
      })
        .then((r) => {
          if (!r.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: " + r.status);
          return r.json();
        })
        .then(showCards)
        .catch((err) => {
          console.error("[RECO] API ì˜¤ë¥˜:", err);
          setLoadingText("ì¶”ì²œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        });
    }

    // -----------------------------
    // 3. ì¹´ë“œ ë Œë”ë§
    // -----------------------------
    function showCards(data) {
      console.log("[RECO] ê²°ê³¼:", data);

      if (!Array.isArray(data) || data.length === 0) {
        setLoadingText("ê·¼ì²˜ ì¶”ì²œ ë§›ì§‘ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        cardsEl.style.display = "none";
        return;
      }

      // ë¡œë”© ì˜ì—­ ìˆ¨ê¸°ê³  ì¹´ë“œ í‘œì‹œ
      loadingEl.style.display = "none";
      cardsEl.style.display = "flex";
      cardsEl.innerHTML = "";

      data.forEach((item) => {
        const card = document.createElement("div");
        card.className = "card";

        const ratingText =
          item.rating && item.rating.toFixed
            ? item.rating.toFixed(1)
            : (item.rating || "-");

        const distanceText =
          item.distance_km != null ? `ì•½ ${item.distance_km}km` : "";

        const keywords = (item.keywords || [])
          .map((k) => `<span class="tag">#${k}</span>`)
          .join(" ");

        // /go ë¼ìš°íŠ¸ í™œìš©í•´ì„œ ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì´ë™
        const mapUrl =
          "/go?phone=" +
          encodeURIComponent(phone || "") +
          "&place_id=" +
          encodeURIComponent(item.place_id || "") +
          "&name=" +
          encodeURIComponent(item.name || "");

        card.innerHTML = `
          <span class="tag">${item.category || "ê¸°íƒ€"}</span>
          <h3>${item.name || ""}</h3>
          <div class="menu">
            ëŒ€í‘œ ë©”ë‰´: ${item.menu || "ì •ë³´ ì—†ìŒ"} 
            ${ratingText !== "-" ? ` Â· â˜… ${ratingText}` : ""}
          </div>
          <div class="desc">
            ${item.summary || ""}
            ${distanceText ? `<br>${distanceText}` : ""}
            ${item.address ? `<br>ğŸ“ ${item.address}` : ""}
            ${item.open_info ? `<br>â° ${item.open_info}` : ""}
            ${keywords ? `<br><br>${keywords}` : ""}
          </div>
          <a class="btn-map" href="${mapUrl}" target="_blank">ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì´ë™</a>
        `;

        cardsEl.appendChild(card);
      });
    }
  </script>

</body>
</html>

