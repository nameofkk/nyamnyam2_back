<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜¤ëŠ˜ì˜ ì¶”ì²œ Â· ëƒ ëƒ ì´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #4b7cff;
      --primary-soft: #e4edff;
      --accent: #ff7b54;
      --bg: #f6f7fb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: #222;
    }

    .page-wrap {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 16px 40px;
    }

    .header {
      width: 100%;
      max-width: 1100px;
      text-align: center;
      margin-bottom: 18px;
    }

    .header-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .header-sub {
      font-size: 13px;
      color: #666;
    }

    .header-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: #3552b8;
      font-size: 12px;
    }

    /* ë¡œë”© ì˜ì—­ */
    #loading {
      margin-top: 32px;
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 14px;
      border-radius: 50%;
      border: 4px solid #dde2f2;
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
    }

    #loading p {
      margin: 0;
      font-size: 14px;
      color: #777;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
    #cards {
      display: none; /* ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ */
      width: 100%;
      max-width: 1100px;
      margin-top: 28px;
      display: flex;
      flex-direction: row;
      gap: 20px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 8px;
    }

    #cards::-webkit-scrollbar {
      display: none;
    }

    .card {
      position: relative;
      flex: 0 0 82%;
      max-width: 340px;
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.07);
      overflow: hidden;
      scroll-snap-align: center;
      display: flex;
      flex-direction: column;
    }

    /* ë°˜ì‘ ì˜¤ë²„ë ˆì´ */
    .reaction-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out;
    }

    .reaction-overlay.show {
      opacity: 1;
    }

    .reaction-emoji {
      font-size: 40px;
      transform: scale(0.8);
      opacity: 0;
    }

    .reaction-emoji.pop {
      animation: reaction-pop 0.6s ease-out forwards;
    }

    @keyframes reaction-pop {
      0% {
        transform: scale(0.2);
        opacity: 0;
      }
      40% {
        transform: scale(1.6);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0;
      }
    }

    /* ì¸ë„¤ì¼ ì˜ì—­ */
    .thumb {
      width: 100%;
      height: 180px;
      position: relative;
      overflow: hidden;
      background: #f2f3f6;
    }

    .thumb-inner {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .main-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scale(1.03);
    }

    .thumb-badge {
      position: absolute;
      bottom: 10px;
      left: 12px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
    }

    /* ì¹´ë“œ ë³¸ë¬¸ */
    .card-body {
      padding: 16px 18px 16px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f3f4ff;
      color: #4b4f8a;
    }

    .badge.rating {
      background: #fff1d5;
      color: #b26a00;
    }

    .menu {
      font-size: 13px;
      color: #444;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .summary {
      font-size: 12px;
      color: #555;
      margin-bottom: 6px;
      line-height: 1.45;
    }

    .keyword-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #ffe9df;
      color: #c0572c;
    }

    .kakao-preview {
      font-size: 11px;
      color: #777;
      line-height: 1.4;
    }

    .bottom-actions {
      margin-top: auto;
      padding-top: 10px;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 8px 0;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-like {
      background: #e9f7ef;
      color: #1e7b3b;
    }

    .btn-dislike {
      background: #fdecec;
      color: #c0392b;
    }

    .btn-map {
      display: block;
      width: 100%;
      text-align: center;
      background: var(--primary);
      color: #fff;
      padding: 10px 0;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: default;
    }

    /* PCì—ì„œ ì¹´ë“œ 3ê°œ ê½‰ ì°¨ê²Œ ë³´ì´ë„ë¡ */
    @media (min-width: 1024px) {
      .page-wrap {
        padding-top: 80px;
      }
      .card {
        flex: 0 0 32%;
        max-width: 360px;
      }
      #cards {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="header">
      <div class="header-title">ì˜¤ëŠ˜ì˜ ë§›ì§‘ ì¶”ì²œ</div>
      <div class="header-sub">{{ phone }}ë‹˜ì„ ìœ„í•œ {{ time }} ì¶”ì²œ 3ê³³</div>
      <div class="header-pill">
        <span>AI ìœ„ì¹˜ ê¸°ë°˜ ì¶”ì²œ</span>
        <span>Â·</span>
        <span>ì¹´ì¹´ì˜¤ë§µ ì—°ë™</span>
      </div>
    </div>

    <div id="loading">
      <div class="spinner"></div>
      <p>AIê°€ ì£¼ë³€ ë§›ì§‘ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="cards"></div>
  </div>

  <script>
    const phone = "{{ phone }}";
    const timeOfDay = "{{ time }}";

    const loadingEl = document.getElementById("loading");
    const loadingTextEl = loadingEl.querySelector("p");
    const cardsEl = document.getElementById("cards");

    function setLoadingText(text) {
      loadingEl.style.display = "block";
      loadingTextEl.innerText = text;
    }

    document.addEventListener("DOMContentLoaded", start);

    function start() {
      console.log("[RECO] start()");

      if (!navigator.geolocation) {
        setLoadingText("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
        fetchReco(33.462046, 126.329235);
        return;
      }

      let called = false;

      function go(lat, lon) {
        if (called) return;
        called = true;
        console.log("[RECO] ìœ„ì¹˜ ì‚¬ìš©:", lat, lon);
        fetchReco(lat, lon);
      }

      try {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            go(pos.coords.latitude, pos.coords.longitude);
          },
          (err) => {
            console.error("[RECO] ìœ„ì¹˜ ì˜¤ë¥˜:", err);
            setLoadingText("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
            go(33.462046, 126.329235);
          },
          {
            enableHighAccuracy: true,
            timeout: 7000,
            maximumAge: 600000,
          }
        );
      } catch (e) {
        console.error("[RECO] ìœ„ì¹˜ API ì˜ˆì™¸:", e);
        setLoadingText("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
        go(33.462046, 126.329235);
      }

      setTimeout(() => {
        if (!called) {
          console.warn("[RECO] ìœ„ì¹˜ ì‘ë‹µ ì§€ì—° â†’ ê¸°ë³¸ ì¢Œí‘œ ì‚¬ìš©");
          setLoadingText("ìœ„ì¹˜ ì‘ë‹µì´ ëŠë¦½ë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.");
          go(33.462046, 126.329235);
        }
      }, 8000);
    }

    function fetchReco(lat, lon) {
      setLoadingText("ì£¼ë³€ ë§›ì§‘ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
      cardsEl.style.display = "none";
      cardsEl.innerHTML = "";

      fetch("/api/reco", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: phone,
          time: timeOfDay,
          lat: lat,
          lon: lon,
        }),
      })
        .then((r) => {
          if (!r.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: " + r.status);
          return r.json();
        })
        .then(showCards)
        .catch((err) => {
          console.error("[RECO] API ì˜¤ë¥˜:", err);
          setLoadingText("ì¶”ì²œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        });
    }

    function showCards(data) {
      console.log("[RECO] ê²°ê³¼:", data);

      if (!Array.isArray(data) || data.length === 0) {
        setLoadingText("ê·¼ì²˜ ì¶”ì²œ ë§›ì§‘ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        cardsEl.style.display = "none";
        return;
      }

      loadingEl.style.display = "none";
      cardsEl.style.display = "flex";
      cardsEl.innerHTML = "";

      data.forEach((item) => {
        const card = document.createElement("div");
        card.className = "card";

        const ratingText =
          item.rating && item.rating.toFixed
            ? item.rating.toFixed(1)
            : (item.rating || "-");

        const distanceText =
          item.distance_km != null ? `ì•½ ${item.distance_km}km` : "";

        const keywords = (item.keywords || [])
          .map((k) => `<span class="tag">#${k}</span>`)
          .join(" ");

        const mainImage =
          (item.images && item.images.length && item.images[0]) ||
          item.image_url ||
          "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumnail.png";

        const kakaoLines = [];
        if (item.address) kakaoLines.push("ğŸ“ " + item.address);
        if (item.open_info) kakaoLines.push("â° " + item.open_info);
        const kakaoInfo =
          kakaoLines.join("<br>") ||
          "ì¹´ì¹´ì˜¤ë§µì—ì„œ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.";

        const mapUrl =
          "/go?phone=" +
          encodeURIComponent(phone || "") +
          "&place_id=" +
          encodeURIComponent(item.place_id || "") +
          "&name=" +
          encodeURIComponent(item.name || "");

        card.innerHTML = `
          <div class="reaction-overlay">
            <div class="reaction-emoji">ğŸ˜†</div>
          </div>

          <div class="thumb">
            <div class="thumb-inner">
              <img class="main-photo" src="${mainImage}" alt="${item.name || ''}">
            </div>
            ${distanceText ? `<div class="thumb-badge">${distanceText}</div>` : ""}
          </div>

          <div class="card-body">
            <div class="card-title">${item.name || ""}</div>
            <div class="badge-row">
              <span class="badge">${item.category || "ê¸°íƒ€"}</span>
              ${ratingText !== "-" ? `<span class="badge rating">â˜… ${ratingText}</span>` : ""}
            </div>
            <div class="menu">ëŒ€í‘œ ë©”ë‰´: ${item.menu || "ì •ë³´ ì—†ìŒ"}</div>
            <div class="summary">${item.summary || ""}</div>
            <div class="keyword-row">
              ${keywords}
            </div>
            <div class="kakao-preview">
              ${kakaoInfo}
            </div>

            <div class="bottom-actions">
              <div class="btn-row">
                <button class="btn btn-like">ğŸ‘ ì¢‹ì•„ìš”</button>
                <button class="btn btn-dislike">ğŸ‘ ë³„ë¡œì˜ˆìš”</button>
              </div>
              <a class="btn-map" href="${mapUrl}" target="_blank">ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì´ë™</a>
            </div>
          </div>
        `;

        cardsEl.appendChild(card);

        const likeBtn = card.querySelector(".btn-like");
        const dislikeBtn = card.querySelector(".btn-dislike");

        likeBtn.addEventListener("click", () =>
          sendQuickFeedback(item, true, likeBtn, dislikeBtn, card)
        );
        dislikeBtn.addEventListener("click", () =>
          sendQuickFeedback(item, false, likeBtn, dislikeBtn, card)
        );
      });
    }

    function sendQuickFeedback(item, isLike, likeBtn, dislikeBtn, cardEl) {
      console.log("[FEEDBACK] sendQuickFeedback", item.name, isLike);

      const overlay = cardEl.querySelector(".reaction-overlay");
      const emoji = cardEl.querySelector(".reaction-emoji");
      if (overlay && emoji) {
        overlay.classList.add("show");
        emoji.classList.add("pop");
        setTimeout(() => {
          overlay.classList.remove("show");
          emoji.classList.remove("pop");
        }, 650);
      }

      const nextCard = cardEl.nextElementSibling;
      if (nextCard) {
        setTimeout(() => {
          nextCard.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        }, 300);
      }

      fetch("/api/quick-feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: phone,
          place_id: item.place_id,
          name: item.name,
          category: item.category,
          like: isLike,
          time_of_day: timeOfDay,
        }),
      })
        .then((r) => r.json())
        .then((res) => {
          if (res && res.ok) {
            if (isLike) {
              likeBtn.innerText = "ğŸ‘ ë°˜ì˜ë¨";
            } else {
              dislikeBtn.innerText = "ğŸ‘ ë°˜ì˜ë¨";
            }
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;
          } else {
            alert("í”¼ë“œë°± ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        })
        .catch((err) => {
          console.error("[QUICK_FEEDBACK_ERROR]", err);
          alert("í”¼ë“œë°± ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }
  </script>
</body>
</html>
